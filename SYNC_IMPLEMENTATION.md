# Реализация системы синхронизации GophKeeper

## Обзор

Система GophKeeper теперь полностью поддерживает:
- PostgreSQL на сервере
- SQLite на клиенте
- Синхронизацию с разрешением конфликтов на основе времени
- Контроль версий с историей изменений (последние 10 версий)

## Архитектура

### Сервер (PostgreSQL)
- **База данных**: PostgreSQL с миграциями
- **Таблицы**:
  - `users` - пользователи
  - `stored_data` - основные данные с полями `is_deleted`, `version`
  - `data_history` - история версий (последние 10)
  - `schema_migrations` - управление миграциями

### Клиент (SQLite)
- **База данных**: SQLite с миграциями
- **Таблицы**: аналогичные серверным, но с SQLite синтаксисом
- **Локальное хранение**: все данные сохраняются локально для офлайн работы

## Механизм синхронизации

### Разрешение конфликтов
1. **По времени**: Если `updated_at` клиента > сервера → клиент побеждает
2. **По версии**: Если время одинаковое, сравнивается `version`
3. **Конфликты**: Если сервер новее, данные помечаются как конфликт

### Алгоритм синхронизации
1. Клиент отправляет данные, измененные с последней синхронизации
2. Сервер сравнивает с локальными данными
3. Применяет правила разрешения конфликтов
4. Возвращает обновленные данные сервера
5. Клиент сохраняет полученные данные локально

## Контроль версий

### История изменений
- Каждое изменение сохраняется в `data_history`
- Хранится последние 10 версий для каждого элемента данных
- Поддерживается soft delete (`is_deleted`)

### Версионирование
- Автоматическое увеличение `version` при изменениях
- Уникальные ID для истории: `{data_id}_v{version}`
- Очистка старых версий (оставляем только 10 последних)

## Использование

### Команды клиента
```bash
# Регистрация и вход
gophkeeper register username email@example.com password
gophkeeper login username password

# Работа с данными
gophkeeper add login_password "My Site" "user" "pass" "https://example.com"
gophkeeper add text "Note" "Important information"
gophkeeper add bank_card "Credit Card" "1234567890123456" "12/25" "123" "John Doe"

# Просмотр и управление
gophkeeper list
gophkeeper get <id>
gophkeeper delete <id>
gophkeeper history <id>  # Показать историю версий

# Синхронизация
gophkeeper sync
```

### Миграции
```bash
# Сервер (PostgreSQL)
make migrate-srv

# Клиент (SQLite)
make migrate-cli
```

## Безопасность

### Шифрование
- Все данные шифруются перед отправкой на сервер
- Используется AES-256-GCM
- Отдельные ключи шифрования для клиента и сервера

### Аутентификация
- JWT токены для авторизации
- Хеширование паролей с солью (SHA-256)

## Структура данных

### Типы данных
- `login_password` - логины и пароли
- `text` - произвольный текст
- `binary` - бинарные данные
- `bank_card` - данные банковских карт

### Метаданные
- Каждый тип поддерживает произвольные метаданные
- JSON структуры для сложных данных

## Тестирование

```bash
# Запуск тестов
make test

# Тесты с покрытием
make test-coverage

# Сборка
make build
make build-all  # Для всех платформ
```

## Развертывание

### Сервер
1. Настроить PostgreSQL
2. Установить переменные окружения для БД
3. Запустить: `make run-server`

### Клиент
1. Скачать бинарный файл для нужной платформы
2. Запустить: `./gophkeeper-client --help`

## Особенности реализации

### Офлайн работа
- Клиент работает полностью офлайн
- Синхронизация происходит по запросу
- Локальная база SQLite для быстрого доступа

### Производительность
- Индексы на часто используемые поля
- Пакетная обработка при синхронизации
- Очистка старых версий для экономии места

### Надежность
- Транзакции для атомарности операций
- Откат при ошибках
- Логирование всех операций
